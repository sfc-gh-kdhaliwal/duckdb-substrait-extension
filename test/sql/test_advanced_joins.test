# name: test/sql/test_advanced_joins.test
# description: Test Substrait generation for advanced join types
# group: [sql]

require substrait

# =============================================================================
# Setup: Create test tables
# =============================================================================

statement ok
CREATE TABLE employees (emp_id INT, name VARCHAR, dept_id INT)

statement ok
CREATE TABLE departments (dept_id INT, dept_name VARCHAR)

statement ok
INSERT INTO employees VALUES (1, 'Alice', 1), (2, 'Bob', 2), (3, 'Charlie', 1), (4, 'Diana', NULL)

statement ok
INSERT INTO departments VALUES (1, 'Engineering'), (2, 'Sales'), (3, 'HR')

# =============================================================================
# Test 1: RIGHT JOIN
# =============================================================================

statement ok
CALL get_substrait('SELECT e.name, d.dept_name FROM employees e RIGHT JOIN departments d ON e.dept_id = d.dept_id')

# =============================================================================
# Test 2: FULL OUTER JOIN
# =============================================================================

statement ok
CALL get_substrait('SELECT e.name, d.dept_name FROM employees e FULL OUTER JOIN departments d ON e.dept_id = d.dept_id')

# =============================================================================
# Test 3: Anti-join pattern (NOT EXISTS)
# =============================================================================

statement ok
CALL get_substrait('SELECT e.name FROM employees e WHERE NOT EXISTS (SELECT 1 FROM departments d WHERE d.dept_id = e.dept_id)')

# =============================================================================
# Test 4: Semi-join pattern (EXISTS)
# =============================================================================

statement ok
CALL get_substrait('SELECT e.name FROM employees e WHERE EXISTS (SELECT 1 FROM departments d WHERE d.dept_id = e.dept_id)')

# =============================================================================
# Test 5: Multiple join conditions with AND
# =============================================================================

statement ok
CALL get_substrait('SELECT e.name, d.dept_name FROM employees e INNER JOIN departments d ON e.dept_id = d.dept_id AND e.emp_id > 1')

# =============================================================================
# Test 6: Multiple join conditions with OR
# SKIP: OR in join condition creates ANY_JOIN which is not yet supported
# =============================================================================

# statement ok
# CALL get_substrait('SELECT e.name, d.dept_name FROM employees e INNER JOIN departments d ON e.dept_id = d.dept_id OR e.dept_id IS NULL')

# =============================================================================
# Test 7: Self-join
# =============================================================================

statement ok
CALL get_substrait('SELECT e1.name, e2.name FROM employees e1 INNER JOIN employees e2 ON e1.dept_id = e2.dept_id AND e1.emp_id < e2.emp_id')

# =============================================================================
# Test 8: Three-way join
# =============================================================================

statement ok
CREATE TABLE projects (proj_id INT, dept_id INT, proj_name VARCHAR)

statement ok
INSERT INTO projects VALUES (1, 1, 'Alpha'), (2, 2, 'Beta')

statement ok
CALL get_substrait('SELECT e.name, d.dept_name, p.proj_name FROM employees e INNER JOIN departments d ON e.dept_id = d.dept_id INNER JOIN projects p ON d.dept_id = p.dept_id')

statement ok
DROP TABLE projects

# =============================================================================
# Cleanup
# =============================================================================

statement ok
DROP TABLE employees

statement ok
DROP TABLE departments
