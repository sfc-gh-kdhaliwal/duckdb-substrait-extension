name: Build DuckDB Substrait Extension

on:
  push:
    branches: [ main, substrat_1.4.2_complete_rewrite, upgrade_duckdb_to_1.4.4 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering from GitHub UI
    inputs:
      duckdb_version:
        description: 'DuckDB version to build against'
        required: false
        default: 'v1.4.4'

env:
  DUCKDB_VERSION: v1.4.4

jobs:
  build-linux-amd64:
    name: Build Linux AMD64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build extension for linux/amd64
        run: |
          chmod +x build_extension_docker_local_optimized.sh
          ./build_extension_docker_local_optimized.sh ${{ github.event.inputs.duckdb_version || env.DUCKDB_VERSION }} ./output linux amd64
        env:
          DOCKER_BUILDKIT: 1
          BUILD_PARALLEL_LEVEL: 4  # Can use more parallelism on real amd64

      - name: Upload linux/amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: substrait-extension-linux-amd64
          path: output/substrait.duckdb_extension.linux_amd64.gz
          retention-days: 30

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-24.04-arm  # Native ARM64 runner - no QEMU needed!

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build extension for linux/arm64
        run: |
          chmod +x build_extension_docker_local_optimized.sh
          ./build_extension_docker_local_optimized.sh ${{ github.event.inputs.duckdb_version || env.DUCKDB_VERSION }} ./output linux arm64
        env:
          DOCKER_BUILDKIT: 1
          BUILD_PARALLEL_LEVEL: 4  # Native ARM64 so we can use more parallelism

      - name: Upload linux/arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: substrait-extension-linux-arm64
          path: output/substrait.duckdb_extension.linux_arm64.gz
          retention-days: 30

  build-macos:
    name: Build macOS (native on ARM64)
    runs-on: macos-14  # M1/M2 runner for native arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake ninja

      - name: Build extension for macOS ARM64
        run: |
          chmod +x build_extension_macos.sh
          ./build_extension_macos.sh ${{ github.event.inputs.duckdb_version || env.DUCKDB_VERSION }} ./output arm64

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: substrait-extension-osx-arm64
          path: output/substrait.duckdb_extension.osx_arm64.gz
          retention-days: 30

  create-release:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [build-linux-amd64, build-linux-arm64, build-macos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: |
          ls -R artifacts/
          echo ""
          echo "Built extensions:"
          find artifacts -name "*.gz" -exec ls -lh {} \;

      - name: Create release info
        run: |
          echo "# DuckDB Substrait Extension Build" > release-info.md
          echo "" >> release-info.md
          echo "**DuckDB Version:** ${{ env.DUCKDB_VERSION }}" >> release-info.md
          echo "**Commit:** ${{ github.sha }}" >> release-info.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release-info.md
          echo "" >> release-info.md
          echo "## Built Artifacts" >> release-info.md
          echo "" >> release-info.md
          find artifacts -name "*.gz" -exec echo "- {}" \; >> release-info.md
          cat release-info.md
